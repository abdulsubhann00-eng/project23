<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Portal App</title>
    
    <!-- 1. Tailwind CSS (For styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FontAwesome (For icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Styles for smooth transitions */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .role-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ================= AUTHENTICATION SCREEN ================= -->
    <div id="auth-screen" class="flex-1 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md fade-in">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                    <i class="fas fa-building"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Corporate Portal</h1>
                <p class="text-gray-500">Please login to continue</p>
            </div>

            <!-- Role Selection -->
            <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                <button onclick="selectRole('manager')" id="btn-manager" class="role-btn flex-1 py-2 rounded-md text-sm font-semibold text-gray-600 transition">Manager</button>
                <button onclick="selectRole('employee')" id="btn-employee" class="role-btn active flex-1 py-2 rounded-md text-sm font-semibold text-gray-600 transition">Employee</button>
                <button onclick="selectRole('customer')" id="btn-customer" class="role-btn flex-1 py-2 rounded-md text-sm font-semibold text-gray-600 transition">Customer</button>
            </div>

            <!-- Login Form -->
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" required placeholder="Enter username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" required placeholder="Enter password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div id="auth-error" class="text-red-500 text-sm hidden text-center"></div>

                <div class="flex gap-3 pt-2">
                    <button type="submit" id="btn-login" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-500/30">Login</button>
                    <button type="button" id="btn-register" class="flex-1 bg-white text-blue-600 border border-blue-600 py-2 rounded-lg hover:bg-blue-50 transition font-bold">Register</button>
                </div>
            </form>
            <p class="text-xs text-center text-gray-400 mt-4">University Project Demo</p>
        </div>
    </div>

    <!-- ================= APP DASHBOARD (Common Layout) ================= -->
    <div id="app-screen" class="hidden-screen flex-1 flex flex-col">
        <!-- Navbar -->
        <header id="navbar" class="text-white shadow-md transition-colors duration-300">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i id="nav-icon" class="fas fa-user-circle text-2xl"></i>
                    <div>
                        <h2 id="nav-title" class="text-lg font-bold">Portal</h2>
                        <p id="user-display" class="text-xs opacity-80">Logged in as...</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition text-sm flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 max-w-6xl w-full mx-auto p-4">
            
            <!-- MANAGER VIEW -->
            <div id="view-manager" class="hidden-screen grid md:grid-cols-2 gap-6">
                <!-- Send Message Panel -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-paper-plane text-blue-600 mr-2"></i>Send Message to Employees</h3>
                    <form id="manager-msg-form" class="space-y-4">
                        <textarea id="msg-content" required placeholder="Type message here..." class="w-full h-32 p-3 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Send Announcement</button>
                    </form>
                </div>

                <!-- Add Product Panel -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-tag text-green-600 mr-2"></i>List Product for Customers</h3>
                    <form id="manager-prod-form" class="space-y-4">
                        <input type="text" id="prod-name" required placeholder="Product Name" class="w-full p-2 border rounded-lg">
                        <input type="number" id="prod-price" required placeholder="Price ($)" class="w-full p-2 border rounded-lg">
                        <input type="text" id="prod-desc" required placeholder="Short Description" class="w-full p-2 border rounded-lg">
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Add Product</button>
                    </form>
                </div>
            </div>

            <!-- EMPLOYEE VIEW -->
            <div id="view-employee" class="hidden-screen">
                <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-inbox text-blue-600 mr-2"></i>Inbox (Messages from Manager)</h3>
                    <div id="employee-msg-list" class="space-y-3">
                        <!-- Messages will appear here -->
                        <p class="text-gray-400 text-center py-4">Waiting for messages...</p>
                    </div>
                </div>
            </div>

            <!-- CUSTOMER VIEW -->
            <div id="view-customer" class="hidden-screen">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">Our Products</h3>
                <div id="customer-prod-list" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Products will appear here -->
                    <p class="text-gray-400 col-span-3 text-center py-10">No products listed yet.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script type="module">
        // 1. Import Firebase Functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Configuration (Uses environment variable or placeholder)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use a unique ID for this session's data
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 3. State Management
        let selectedRole = 'employee';
        let currentUser = null;

        // 4. Auth & UI Functions
        
        // Connect to Firebase anonymously first (to allow reading/writing based on our logic)
        signInAnonymously(auth).catch(console.error);

        window.selectRole = (role) => {
            selectedRole = role;
            // Update UI buttons
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(btn-${role}).classList.add('active');
        };

        // --- LOGIN LOGIC ---
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userIn = document.getElementById('username').value.trim();
            const passIn = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('auth-error');

            // 1. Fetch users from Database
            // Note: In a real app, you'd use query(), but for this simple student app we filter client side
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'simple_users');
            
            // We use onSnapshot for a one-time check here for simplicity
            onSnapshot(usersRef, (snapshot) => {
                const users = snapshot.docs.map(doc => doc.data());
                
                // 2. Check credentials
                const foundUser = users.find(u => 
                    u.username.toLowerCase() === userIn.toLowerCase() && 
                    u.password === passIn && 
                    u.role === selectedRole
                );

                if (foundUser) {
                    loginSuccess(foundUser);
                } else {
                    errorDiv.innerText = "Invalid username, password, or role!";
                    errorDiv.classList.remove('hidden');
                }
            });
        });

        // --- REGISTER LOGIC ---
        document.getElementById('btn-register').addEventListener('click', async () => {
            const userIn = document.getElementById('username').value.trim();
            const passIn = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('auth-error');

            if(!userIn || !passIn) {
                errorDiv.innerText = "Please fill all fields.";
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'simple_users'), {
                    username: userIn,
                    password: passIn,
                    role: selectedRole,
                    createdAt: serverTimestamp()
                });
                alert("Registration Successful! Please click Login.");
            } catch (err) {
                console.error(err);
                errorDiv.innerText = "Error registering.";
                errorDiv.classList.remove('hidden');
            }
        });

        // --- DASHBOARD LOGIC ---
        function loginSuccess(user) {
            currentUser = user;
            
            // Hide Auth, Show App
            document.getElementById('auth-screen').classList.add('hidden-screen');
            document.getElementById('app-screen').classList.remove('hidden-screen');

            // Setup Navbar
            const nav = document.getElementById('navbar');
            const title = document.getElementById('nav-title');
            const display = document.getElementById('user-display');

            display.innerText = Logged in as ${user.username};

            // Reset views
            document.getElementById('view-manager').classList.add('hidden-screen');
            document.getElementById('view-employee').classList.add('hidden-screen');
            document.getElementById('view-customer').classList.add('hidden-screen');

            // Show specific view based on role
            if (user.role === 'manager') {
                nav.classList.add('bg-slate-800');
                title.innerText = "Manager Portal";
                document.getElementById('view-manager').classList.remove('hidden-screen');
                setupManagerListeners();
            } else if (user.role === 'employee') {
                nav.classList.add('bg-blue-600');
                title.innerText = "Employee Portal";
                document.getElementById('view-employee').classList.remove('hidden-screen');
                setupEmployeeData();
            } else if (user.role === 'customer') {
                nav.classList.add('bg-orange-500');
                title.innerText = "Customer Store";
                document.getElementById('view-customer').classList.remove('hidden-screen');
                setupCustomerData();
            }
        }

        window.logout = () => {
            location.reload(); // Simple reload to clear state
        };

        // --- MANAGER FUNCTIONS ---
        function setupManagerListeners() {
            // Send Message
            document.getElementById('manager-msg-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = document.getElementById('msg-content').value;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    content: content,
                    from: currentUser.username,
                    timestamp: serverTimestamp()
                });
                alert("Message sent to employees!");
                document.getElementById('msg-content').value = '';
            });

            // Add Product
            document.getElementById('manager-prod-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('prod-name').value;
                const price = document.getElementById('prod-price').value;
                const desc = document.getElementById('prod-desc').value;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                    name, price, desc,
                    addedBy: currentUser.username,
                    timestamp: serverTimestamp()
                });
                alert("Product listed for customers!");
                document.getElementById('manager-prod-form').reset();
            });
        }

        // --- EMPLOYEE FUNCTIONS (Read Messages) ---
        function setupEmployeeData() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('employee-msg-list');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-400">No messages yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const html = `
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg flex items-start gap-3">
                            <div class="bg-blue-200 p-2 rounded-full"><i class="fas fa-envelope text-blue-700"></i></div>
                            <div>
                                <h4 class="font-bold text-gray-800">From Manager (${msg.from})</h4>
                                <p class="text-gray-600 mt-1">${msg.content}</p>
                            </div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            });
        }

        // --- CUSTOMER FUNCTIONS (Read Products) ---
        function setupCustomerData() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'products'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('customer-prod-list');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-400 col-span-3 text-center">No products found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const prod = doc.data();
                    const html = `
                        <div class="bg-white border rounded-xl overflow-hidden hover:shadow-lg transition">
                            <div class="h-32 bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-box-open text-4xl text-gray-300"></i>
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg text-gray-800">${prod.name}</h4>
                                    <span class="bg-green-100 text-green-700 font-bold px-2 py-1 rounded text-sm">$${prod.price}</span>
                                </div>
                                <p class="text-gray-500 text-sm">${prod.desc}</p>
                                <button class="w-full mt-4 bg-orange-500 text-white py-2 rounded hover:bg-orange-600 transition">Buy Now</button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            });
        }

    </script>
</body>
</html>